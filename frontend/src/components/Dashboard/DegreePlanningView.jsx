import React, { useState, useEffect, useMemo, useRef } from 'react'
import {
  FaHeart, FaRegHeart, FaCheckCircle, FaStar, FaBook,
  FaBullseye, FaFileUpload, FaChevronDown, FaChevronUp,
  FaGraduationCap, FaListAlt, FaLightbulb, FaExternalLinkAlt,
  FaChevronRight, FaCircle, FaBolt
} from 'react-icons/fa'
import { useLanguage } from '../../contexts/LanguageContext'
import DegreeProgressTracker from './DegreeProgressTracker'
import DegreeRequirementsView from './DegreeRequirementsView'
import './DegreePlanningView.css'

// Fix double /api/api bug
const rawBase = import.meta.env.VITE_API_URL || 'http://localhost:8000'
const API_BASE = rawBase.replace(/\/api\/?$/, '')

// Map profile major/minor names to program_keys
function toProgramKey(name, type = 'major', faculty = '') {
  if (!name) return null
  const fl = faculty.toLowerCase()
  const isSci = fl.includes('science') && !fl.includes('arts & science') && !fl.includes('arts and science')
  const isBasc = fl.includes('arts & science') || fl.includes('arts and science')
  const isEng  = fl.includes('engineering')
  const isEnv  = fl.includes('environment') || fl.includes('bieler')

  // Bieler School of Environment B.A. programs
  if (isEnv) {
    const envMap = {
      'Ecological Determinants of Health in Society': 'environment_ecological_determinants_ba',
      'Economics and the Earth\'s Environment': 'environment_economics_earth_ba',
      'Environment and Development': 'environment_development_ba',
    }
    if (envMap[name]) return envMap[name]
    if (type === 'minor') return 'environment_minor_ba'
    if (type === 'diploma') return 'environment_diploma'
  }

  // B.A. & Sc. interfaculty programs
  if (isBasc) {
    const bascMap = {
      'Cognitive Science': 'cogs_interfaculty',
      'Cognitive Science (Honours)': 'cogs_honours',
      'Sustainability, Science and Society': 'sss_interfaculty',
      'Sustainability, Science and Society (Honours)': 'sss_honours',
      'Environment': 'environment_interfaculty',
      'Environment (Honours)': 'environment_honours',
    }
    if (bascMap[name]) return `${bascMap[name]}_basc`
    // Fall through to arts/science maps for multi-track
  }

  // Science programs use _bsc suffix
  if (isSci) {
    const sciMap = {
      'Computer Science': 'cs',
      'Software Engineering': 'software_engineering',
      'Mathematics': 'mathematics',
      'Statistics': 'statistics',
      'Applied Mathematics': 'applied_mathematics',
      'Physics': 'physics',
      'Biology': 'biology',
      'Chemistry': 'chemistry',
      'Biochemistry': 'biochemistry',
      'Neuroscience': 'neuroscience',
      'Physiology': 'physiology',
      'Microbiology and Immunology': 'micro_immuno',
      'Earth and Planetary Sciences': 'earth_planetary',
      'Atmospheric and Oceanic Sciences': 'atmos_oceanic',
      'Environmental Science': 'environmental_science',
      'Geography': 'geography_sci',
    }
    const slug = sciMap[name] || name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '')
    return `${slug}_${type}_bsc`
  }

  // Management (Desautels) programs
  if (fl.includes('management') || fl.includes('desautels')) {
    const mgmtSlugMap = {
      'Accounting': 'accounting',
      'Finance': 'finance',
      'Marketing': 'marketing',
      'Business Analytics': 'business_analytics',
      'Strategic Management': 'strategic_management',
      'Information Technology Management': 'it_management',
      'Organizational Behaviour and Human Resources': 'ob_hr',
      'International Management': 'intl_management',
      'Managing for Sustainability': 'managing_sustainability',
      'Retail Management': 'retail_management',
      'Economics for Management Students': 'economics_management',
      'Mathematics and Statistics for Management': 'math_stats_management',
      'Investment Management': 'investment_management',
    }
    const slug = mgmtSlugMap[name] || name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '')
    if (type === 'honours') return `${slug}_honours_bcom`
    if (type === 'concentration') return `${slug}_concentration_bcom`
    return `${slug}_major_bcom`
  }

  const map = {
    'Anthropology': 'anthropology',
    'Art History': 'art_history',
    'Economics': 'economics',
    'Political Science': 'political_science',
    'Psychology': 'psychology',
    'Sociology': 'sociology',
    'Linguistics': 'linguistics',
    'History': 'history',
    'Philosophy': 'philosophy',
    'English': 'english_literature',
    'English Literature': 'english_literature',
    'Communication Studies': 'communication_studies',
    'International Development Studies': 'intl_development',
    'International Development': 'intl_development',
    'Gender, Sexuality, Feminist and Social Justice Studies': 'gsfsj',
    'Canadian Studies': 'canadian_studies',
    'Classical Studies': 'classics',
    'Classics': 'classics',
    'Jewish Studies': 'jewish_studies',
    'East Asian Studies': 'east_asian_studies',
    'Geography': 'geography',
    'Computer Science': 'computer_science_arts',
    'German Studies': 'german_studies',
    'Hispanic Studies': 'hispanic_studies',
    'Italian Studies': 'italian_studies',
    'Religious Studies': 'religious_studies',
    'African Studies': 'african_studies',
    'Information Studies': 'information_studies',
    'Latin American and Caribbean Studies': 'latin_american_caribbean',
    'Liberal Arts': 'liberal_arts',
    'French': 'french',
    'French Language and Literature': 'french',
    'Cognitive Science': 'cognitive_science',
    'European Literature and Culture': 'european_lit_culture',
    'World Islamic and Middle East Studies': 'world_islamic_middle_east',
    // Science for Arts
    'Science for Arts Students': 'science_for_arts_students',
    'Science for Arts': 'science_for_arts_students',
    // Engineering programs
    'Software Engineering': 'software_engineering_coop',
    'Computer Engineering': 'computer_engineering',
    'Electrical Engineering': 'electrical_engineering',
    'Mechanical Engineering': 'mechanical_engineering',
    'Civil Engineering': 'civil_engineering',
    'Chemical Engineering': 'chemical_engineering',
    'Bioengineering': 'bioengineering',
    'Mining Engineering': 'mining_engineering',
    'Materials Engineering': 'materials_engineering_coop',
  }
  const slug = map[name] || name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '')
  return `${slug}_${type}`
}

function matchCourse(req, userCourses) {
  if (!req.catalog) return null
  const key = `${req.subject} ${req.catalog}`.toUpperCase()
  return userCourses.find(c =>
    `${c.subject || ''} ${c.catalog || ''}`.toUpperCase() === key
  ) || null
}

// Transfer credits show as done but do NOT count toward credits
function normalizeCode(code) {
  return (code || '').toUpperCase()
    .replace(/([A-Z])(\d)/g, '$1 $2')  // COMP202 -> COMP 202
    .replace(/\s+/g, ' ')
    .trim()
}
function matchTransfer(req, advancedStanding = [], { requireMajorCredit = false } = {}) {
  if (!req.catalog) return false
  const key = normalizeCode(`${req.subject} ${req.catalog}`)
  return advancedStanding.some(t => {
    if (normalizeCode(t.course_code) !== key) return false
    if (requireMajorCredit) return !!t.counts_toward_major
    return true
  })
}

// â”€â”€ Accordion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AccordionCard({ icon, title, count, accentColor, defaultOpen = true, children }) {
  const [open, setOpen] = useState(defaultOpen)
  return (
    <div className={`dp-accordion ${open ? 'dp-accordion--open' : ''}`}>
      <button className="dp-accordion-header" onClick={() => setOpen(o => !o)}>
        <div className="dp-accordion-left">
          <span className="dp-accordion-icon" style={{ color: accentColor }}>{icon}</span>
          <span className="dp-accordion-title">{title}</span>
          {count != null && count > 0 && (
            <span className="dp-accordion-badge" style={{ background: accentColor }}>{count}</span>
          )}
        </div>
        <span className="dp-accordion-chevron">{open ? <FaChevronUp /> : <FaChevronDown />}</span>
      </button>
      {open && <div className="dp-accordion-body">{children}</div>}
    </div>
  )
}

function EmptyState({ icon, title, subtitle }) {
  return (
    <div className="dp-empty">
      <span className="dp-empty-icon">{icon}</span>
      <p className="dp-empty-title">{title}</p>
      <p className="dp-empty-sub">{subtitle}</p>
    </div>
  )
}

function CourseRow({ course, onClick, actions }) {
  return (
    <div className="dp-course-row">
      <div className="dp-course-info" onClick={onClick}>
        <span className="dp-course-code">{course.subject} {course.catalog}</span>
        <span className="dp-course-title">{course.course_title || course.title}</span>
        {(course.term || course.year || course.credits) && (
          <span className="dp-course-meta">
            {course.term && course.year ? `${course.term} ${course.year}` : ''}
            {course.credits ? ` Â· ${course.credits} cr` : ''}
          </span>
        )}
      </div>
      <div className="dp-course-actions">{actions}</div>
    </div>
  )
}


// â”€â”€ Electives Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ElectivesPanel({ profile, completedCourses, currentCourses, programData, minorData }) {
  const [recs, setRecs]       = useState(null)
  const [loading, setLoading] = useState(false)
  const [error, setError]     = useState(null)
  const hasLoaded             = useRef(false)

  const allCourses = useMemo(
    () => [...completedCourses, ...currentCourses],
    // eslint-disable-next-line react-hooks/exhaustive-deps
    [completedCourses.length, currentCourses.length]
  )
  const courseList = useMemo(
    () => allCourses.map(c => `${c.subject} ${c.catalog} ${c.course_title || ''}`).join(', '),
    [allCourses]
  )

  const generateRecs = async () => {
    setLoading(true)
    setError(null)
    try {
      const advancedStanding = profile?.advanced_standing || []
      const allCourses = [...completedCourses, ...currentCourses]
      const coursesTaken = [
        ...allCourses.map(c => `${c.subject} ${c.catalog} ${c.course_title || ''}`.trim()),
        ...advancedStanding.map(t => `${t.course_code} ${t.course_title || '(transfer)'}`.trim()),
      ]

      // Build list of required major/minor courses to exclude from electives
      const requiredCodes = new Set()
      ;[programData, minorData].forEach(prog => {
        prog?.blocks?.forEach(b => b.courses?.forEach(c => {
          if (c.catalog) requiredCodes.add(`${c.subject} ${c.catalog}`.toUpperCase())
        }))
      })
      const excludeCourses = Array.from(requiredCodes)

      const res = await fetch(`${API_BASE}/api/electives/recommend`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          major:          profile?.major        || null,
          minor:          profile?.minor        || null,
          concentration:  profile?.concentration|| null,
          year:           profile?.year         || null,
          interests:      profile?.interests    || null,
          courses_taken:  coursesTaken,
          exclude_courses: excludeCourses,
        })
      })
      if (!res.ok) throw new Error(`HTTP ${res.status}`)
      const data = await res.json()
      if (!data.success) throw new Error(data.detail || 'Failed')
      setRecs(data.data)
    } catch(e) {
      setError('Could not generate recommendations. Try again.')
    } finally {
      setLoading(false)
    }
  }

  // Auto-generate once on first mount; re-generate only when major/minor/interests change
  // eslint-disable-next-line react-hooks/exhaustive-deps
  useEffect(() => {
    if (hasLoaded.current) return
    hasLoaded.current = true
    generateRecs()
  }, [])

  // Re-generate when profile identity changes (not on every course list tweak)
  const profileKey = `${profile?.major}|${profile?.minor}|${profile?.interests}`
  const prevProfileKey = useRef(profileKey)
  useEffect(() => {
    if (!hasLoaded.current) return
    if (prevProfileKey.current === profileKey) return
    prevProfileKey.current = profileKey
    generateRecs()
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [profileKey])

  const CATEGORY_COLORS = {
    'Breadth':         { bg: '#eff6ff', color: '#1d4ed8' },
    'Career':          { bg: '#f0fdf4', color: '#15803d' },
    'Advanced':        { bg: '#faf5ff', color: '#7c3aed' },
    'Interdisciplinary': { bg: '#fff7ed', color: '#c2410c' },
    'Interest':        { bg: '#fef9c3', color: '#92400e' },
  }

  return (
    <div className="dp-electives">
      <div className="dp-electives-header">
        <div className="dp-electives-title-row">
          <span className="dp-electives-spark">âœ¦</span>
          <div>
            <h3 className="dp-electives-title">Recommended Electives</h3>
            <p className="dp-electives-sub">
              Personalized for {[profile?.major, profile?.minor].filter(Boolean).join(' + ')}
              {profile?.interests ? ` Â· ${profile.interests}` : ''}
            </p>
          </div>
        </div>
        <button className="dp-electives-refresh" onClick={generateRecs} disabled={loading}>
          {loading ? '...' : 'â†»'}
        </button>
      </div>

      {loading && (
        <div className="dp-electives-loading">
          <div className="dp-req-spinner" />
          <span>Generating personalized recommendationsâ€¦</span>
        </div>
      )}

      {error && !loading && (
        <div className="dp-electives-error">
          {error}
          <button onClick={generateRecs}>Retry</button>
        </div>
      )}

      {recs && !loading && (
        <>
          {recs.theme && (
            <p className="dp-electives-theme">ðŸ’¡ {recs.theme}</p>
          )}
          <div className="dp-electives-grid">
            {recs.recommendations?.map((c, i) => {
              const alreadyTaken = [...completedCourses, ...currentCourses].some(uc =>
                `${uc.subject} ${uc.catalog}`.toUpperCase() === `${c.subject} ${c.catalog}`.toUpperCase()
              )
              const catStyle = CATEGORY_COLORS[c.category] || CATEGORY_COLORS['Breadth']
              return (
                <div key={i} className={`dp-elective-card ${alreadyTaken ? 'dp-elective-card--taken' : ''}`}>
                  <div className="dp-elective-top">
                    <span className="dp-elective-code">{c.subject} {c.catalog}</span>
                    <span className="dp-elective-cat" style={{ background: catStyle.bg, color: catStyle.color }}>
                      {c.category}
                    </span>
                    {alreadyTaken && <span className="dp-elective-taken">âœ“ Taking</span>}
                  </div>
                  <p className="dp-elective-title">{c.title}</p>
                  <p className="dp-elective-why">{c.why}</p>
                  <span className="dp-elective-credits">{c.credits} cr</span>
                </div>
              )
            })}
          </div>
        </>
      )}
    </div>
  )
}

// â”€â”€ My Program Requirements card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ProgramSection({ prog, completedCourses, currentCourses, advStanding, openBlocks, setOpenBlocks }) {
  if (!prog) return null

  // Progress: count all matched non-transfer courses toward total_credits
  const totalCredits = prog.total_credits || 36
  let earnedCredits = 0
  const seenKeys = new Set()
  prog.blocks?.forEach(b => b.courses?.forEach(c => {
    if (!c.catalog) return
    const key = `${c.subject} ${c.catalog}`.toUpperCase()
    if (seenKeys.has(key)) return
    seenKeys.add(key)
    const isTransfer = matchTransfer(c, advStanding)
    if (!isTransfer) {
      const inCompleted = completedCourses.some(uc => `${uc.subject} ${uc.catalog}`.toUpperCase() === key)
      const inCurrent   = currentCourses.some(uc => `${uc.subject} ${uc.catalog}`.toUpperCase() === key)
      if (inCompleted || inCurrent) earnedCredits += parseFloat(c.credits || 3)
    }
  }))
  const pct = Math.min(100, Math.round((earnedCredits / totalCredits) * 100))

  return (
    <div className="dp-prog-section">
      {/* Progress bar */}
      <div className="dp-prog-bar-wrap">
        <div className="dp-prog-bar-track">
          <div className="dp-prog-bar-fill" style={{ width: `${pct}%` }} />
        </div>
        <span className="dp-prog-bar-label">{earnedCredits} / {totalCredits} credits</span>
      </div>

      {/* Blocks */}
      {prog.blocks?.map(block => {
        const isOpen = openBlocks[block.id]
        // For block progress: count matched courses (any, not just is_required)
        const blockCourses = block.courses?.filter(c => c.catalog) || []
        const blockMatched = blockCourses.filter(c => {
          const key = `${c.subject} ${c.catalog}`.toUpperCase()
          if (matchTransfer(c, advStanding)) return false
          return completedCourses.some(uc => `${uc.subject} ${uc.catalog}`.toUpperCase() === key) ||
                 currentCourses.some(uc => `${uc.subject} ${uc.catalog}`.toUpperCase() === key)
        })
        const creditsNeeded = block.credits_needed || 0
        const creditsEarned = blockMatched.reduce((s, c) => s + parseFloat(c.credits || 3), 0)
        const blockDone = creditsNeeded > 0 && creditsEarned >= creditsNeeded

        return (
          <div key={block.id} className={`dp-req-block ${blockDone ? 'dp-req-block--done' : ''}`}>
            <button
              className="dp-req-block-header"
              onClick={() => setOpenBlocks(p => ({ ...p, [block.id]: !p[block.id] }))}
            >
              <div className="dp-req-block-left">
                <span className="dp-req-block-chevron">{isOpen ? <FaChevronDown /> : <FaChevronRight />}</span>
                <span className="dp-req-block-name">{block.title}</span>
                {block.credits_needed && <span className="dp-req-block-cr">{block.credits_needed}cr</span>}
              </div>
              <div className="dp-req-block-right">
                <span className={`dp-req-pill ${blockDone ? 'dp-req-pill--done' : ''}`}>
                  {blockDone ? 'âœ“' : `${creditsEarned}/${creditsNeeded}cr`}
                </span>
              </div>
            </button>

            {isOpen && (
              <div className="dp-req-block-courses">
                {block.notes && <p className="dp-req-block-note">{block.notes}</p>}
                {block.courses?.map(c => {
                  const key = `${c.subject} ${c.catalog}`.toUpperCase()
                  const isTransfer = matchTransfer(c, advStanding)
                  const done = isTransfer || completedCourses.some(uc => `${uc.subject} ${uc.catalog}`.toUpperCase() === key)
                  const taking = !done && currentCourses.some(uc => `${uc.subject} ${uc.catalog}`.toUpperCase() === key)
                  return (
                    <div key={c.id} className={`dp-req-course ${done ? 'dp-req-course--done' : ''} ${taking ? 'dp-req-course--taking' : ''}`}>
                      {done
                        ? <FaCheckCircle className="dp-req-course-icon dp-req-course-icon--done" />
                        : taking
                          ? <FaCircle className="dp-req-course-icon dp-req-course-icon--taking" />
                          : <FaCircle className="dp-req-course-icon dp-req-course-icon--empty" />
                      }
                      <span className="dp-req-course-code">{c.subject} {c.catalog || 'â€¢â€¢â€¢'}</span>
                      <span className="dp-req-course-title">{c.title}</span>
                      {done && isTransfer  && <span className="dp-req-transfer-tag">Transfer</span>}
                      {done && !isTransfer && <span className="dp-req-done-tag">Done</span>}
                      {taking             && <span className="dp-req-taking-tag">Taking</span>}
                    </div>
                  )
                })}
              </div>
            )}
          </div>
        )
      })}
    </div>
  )
}

function MyProgramCard({ profile, completedCourses, currentCourses }) {
  const [programData, setProgramData]         = useState(null)
  const [minorData, setMinorData]             = useState(null)
  const [sciData, setSciData]                 = useState(null)
  const [coreData, setCoreData]               = useState(null)
  const [concentrationData, setConcentrationData] = useState(null)
  const [loading, setLoading]                 = useState(false)
  const [seeding, setSeeding]                 = useState(false)
  const [openBlocks, setOpenBlocks]           = useState({})
  const [activeTab, setActiveTab]             = useState('major')
  const [loadFailed, setLoadFailed]           = useState(false)
  const [unavailable, setUnavailable]         = useState({ major: false, minor: false, core: false, concentration: false })

  const advStanding = profile?.advanced_standing || []

  const isBasc          = profile?.faculty === 'Bachelor of Arts and Science'
  const bascStream      = isBasc ? (profile?.concentration || 'Interfaculty') : null
  const bascIsMultiTrack = bascStream === 'Multi-track' || bascStream === 'Joint Honours'

  const isMgmt = !isBasc && (
    profile?.faculty === 'Management' ||
    (profile?.faculty || '').toLowerCase().includes('management') ||
    (profile?.faculty || '').toLowerCase().includes('desautels')
  )

  // Foundation year waived if Arts or B.A. & Sc. with 24+ transfer credits
  const transferCredits = advStanding.reduce((s, c) => s + (c.credits || 0), 0)
  const foundationWaived = transferCredits >= 24 &&
    (profile?.faculty === 'Faculty of Arts' || isBasc)

  const majorKey = toProgramKey(
    profile?.major,
    'major',
    isBasc && !bascIsMultiTrack ? 'Faculty of Arts & Science' : (profile?.faculty || '')
  )
  const sciKey = isBasc && bascIsMultiTrack
    ? toProgramKey(profile?.other_majors?.[0], 'major', 'Faculty of Science')
    : null
  const minorKey = !isMgmt ? toProgramKey(profile?.minor, 'minor', profile?.faculty || '') : null
  // Management-specific keys
  const coreKey          = isMgmt ? 'bcom_core' : null
  const concentrationKey = isMgmt && profile?.concentration
    ? toProgramKey(profile.concentration, 'concentration', profile?.faculty || '')
    : null

  const fetchProgram = async (key, setter) => {
    if (!key) return 'skip'
    try {
      const res = await fetch(`${API_BASE}/api/degree-requirements/programs/${key}`, {
        cache: 'no-store'
      })
      if (res.status === 404) {
        return 'not_found'
      }
      if (!res.ok) return 'error'
      const data = await res.json()
      setter(data)
      setOpenBlocks(prev => {
        const init = { ...prev }
        data.blocks?.forEach((b, i) => { if (i < 2) init[b.id] = true })
        return init
      })
      return 'ok'
    } catch {
      return 'error'
    }
  }

  const fetchedRef = React.useRef(false)

  useEffect(() => {
    if (!profile) return
    if (!majorKey && !minorKey && !sciKey) return
    setLoading(true)
    setLoadFailed(false)
    setProgramData(null)
    setMinorData(null)
    setSciData(null)
    setUnavailable({ major: false, minor: false })
    fetchedRef.current = true

    Promise.all([
      fetchProgram(majorKey, setProgramData),
      fetchProgram(minorKey, setMinorData),
      fetchProgram(sciKey, setSciData),
      fetchProgram(coreKey, setCoreData),
      fetchProgram(concentrationKey, setConcentrationData),
    ]).then(([majorResult, minorResult, , coreResult, concResult]) => {
      setUnavailable({
        major:         majorResult === 'not_found',
        minor:         minorResult === 'not_found',
        core:          coreResult  === 'not_found',
        concentration: concResult  === 'not_found',
      })
    }).finally(() => setLoading(false))
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [majorKey, minorKey, sciKey, coreKey, concentrationKey, !!profile, profile?.concentration])

  const allCourseKeys = useMemo(
    () => [...completedCourses, ...currentCourses].map(c => `${c.subject} ${c.catalog}`).join(','),
    [completedCourses, currentCourses]
  )

  const handleSeed = async () => {
    setSeeding(true)
    try {
      const res = await fetch(`${API_BASE}/api/degree-requirements/seed`, { method: 'POST' })
      const data = await res.json()
      if (data.success) {
        const [majorResult, minorResult, , coreResult, concResult] = await Promise.all([
          fetchProgram(majorKey, setProgramData),
          fetchProgram(minorKey, setMinorData),
          fetchProgram(sciKey, setSciData),
          fetchProgram(coreKey, setCoreData),
          fetchProgram(concentrationKey, setConcentrationData),
        ])
        setUnavailable({
          major:         majorResult === 'not_found',
          minor:         minorResult === 'not_found',
          core:          coreResult  === 'not_found',
          concentration: concResult  === 'not_found',
        })
      }
    } catch {}
    finally { setSeeding(false) }
  }

  const hasSomething = profile?.major || profile?.minor ||
    (isBasc && profile?.other_majors?.length > 0) ||
    isMgmt
  if (!hasSomething) return null

  const hasMajor        = !!programData
  const hasMinor        = !!minorData
  const hasCore         = !!coreData
  const hasConcentration = !!concentrationData
  const hasAny          = hasMajor || hasMinor || hasCore || hasConcentration

  const tabs = []
  if (isMgmt) {
    tabs.push({ id: 'core', label: 'BCom Core', data: coreData, unavailable: unavailable.core })
    if (profile?.major) tabs.push({ id: 'major', label: profile.major, data: programData, unavailable: unavailable.major })
    if (profile?.concentration) tabs.push({ id: 'concentration', label: profile.concentration, data: concentrationData, unavailable: unavailable.concentration })
  } else {
    let majorLabel
    if (isBasc && bascIsMultiTrack) {
      majorLabel = profile?.major ? `${profile.major} (Arts)` : null
    } else {
      majorLabel = profile?.major || null
    }
    if (majorLabel) tabs.push({ id: 'major', label: majorLabel, data: programData, unavailable: unavailable.major })
    if (isBasc && bascIsMultiTrack && profile?.other_majors?.[0]) {
      tabs.push({ id: 'sci', label: `${profile.other_majors[0]} (Science)`, data: sciData, unavailable: false })
    }
    if (profile?.minor) tabs.push({ id: 'minor', label: profile.minor, data: minorData, unavailable: unavailable.minor })
  }
  const currentTab = tabs.find(t => t.id === activeTab) || tabs[0]
  const currentTabData = currentTab?.data
  const currentTabUnavailable = currentTab?.unavailable

  const calcRingProgress = (prog) => {
    if (!prog) return { pct: 0, earned: 0, total: prog?.total_credits || 36 }
    const total = prog.total_credits || 36
    let earned = 0
    const seen = new Set()
    prog.blocks?.forEach(b => b.courses?.forEach(c => {
      if (!c.catalog) return
      const key = `${c.subject} ${c.catalog}`.toUpperCase()
      if (seen.has(key)) return
      seen.add(key)
      if (matchTransfer(c, advStanding)) return
      const matched = completedCourses.some(uc => `${uc.subject} ${uc.catalog}`.toUpperCase() === key) ||
                      currentCourses.some(uc => `${uc.subject} ${uc.catalog}`.toUpperCase() === key)
      if (matched) earned += parseFloat(c.credits || 3)
    }))
    return { pct: Math.min(100, Math.round((earned / total) * 100)), earned, total }
  }

  const majorRing        = calcRingProgress(programData)
  const minorRing        = calcRingProgress(minorData)
  const coreRing         = calcRingProgress(coreData)
  const concentrationRing = calcRingProgress(concentrationData)

  return (
    <div className="dp-req-card">
      <div className="dp-req-card-header">
        <span className="dp-req-card-icon"><FaListAlt /></span>
        <div>
          <h2 className="dp-req-card-title">My Program Requirements</h2>
          <p className="dp-req-card-sub">
            {isMgmt
              ? ['BCom Core', profile?.major, profile?.concentration].filter(Boolean).join(' Â· ')
              : [profile?.major, profile?.minor].filter(Boolean).join(' Â· ')
            }
          </p>
        </div>
      </div>

      {loading && (
        <div className="dp-req-loading"><div className="dp-req-spinner" /> Loading requirementsâ€¦</div>
      )}

      {!loading && !hasAny && !unavailable.major && !unavailable.minor && (
        <div className="dp-req-empty">
          <p>Requirements not loaded yet.</p>
          <button className="dp-req-seed-btn" onClick={handleSeed} disabled={seeding}>
            <FaBolt /> {seeding ? 'Loadingâ€¦' : 'Load Requirements'}
          </button>
        </div>
      )}

      {!loading && !hasAny && (unavailable.major || unavailable.minor) && (
        <div className="dp-req-empty">
          <p style={{ color: 'var(--text-secondary, #6b7280)', fontSize: '0.9rem' }}>
            Detailed requirements for{' '}
            {[
              unavailable.major && profile?.major,
              unavailable.minor && profile?.minor,
            ].filter(Boolean).join(' and ')}{' '}
            are not yet available. We're working on adding more programs!
          </p>
          <p style={{ color: 'var(--text-tertiary, #9ca3af)', fontSize: '0.8rem', marginTop: '0.25rem' }}>
            You can still browse available programs in the Degree Requirements tab.
          </p>
        </div>
      )}

      {!loading && hasAny && (
        <div className="dp-req-body">

          {/* Progress rings */}
          <div className="dp-req-progress-row">
            {isMgmt ? (
              <>
                {hasCore && (
                  <div className="dp-req-progress-item">
                    <div className="dp-req-ring">
                      <svg viewBox="0 0 36 36" className="dp-req-ring-svg">
                        <circle cx="18" cy="18" r="15.9" className="dp-req-ring-bg" />
                        <circle cx="18" cy="18" r="15.9"
                          className="dp-req-ring-fill dp-req-ring-fill--minor"
                          strokeDasharray={`${coreRing.pct} ${100 - coreRing.pct}`}
                          strokeDashoffset="25"
                        />
                      </svg>
                      <span className="dp-req-ring-label">{coreRing.pct}%</span>
                    </div>
                    <div className="dp-req-prog-text">
                      <span className="dp-req-prog-name">Core</span>
                      <span className="dp-req-prog-detail">{coreRing.earned}/{coreRing.total} credits</span>
                    </div>
                  </div>
                )}
                {hasMajor && (
                  <div className="dp-req-progress-item">
                    <div className="dp-req-ring">
                      <svg viewBox="0 0 36 36" className="dp-req-ring-svg">
                        <circle cx="18" cy="18" r="15.9" className="dp-req-ring-bg" />
                        <circle cx="18" cy="18" r="15.9"
                          className="dp-req-ring-fill dp-req-ring-fill--major"
                          strokeDasharray={`${majorRing.pct} ${100 - majorRing.pct}`}
                          strokeDashoffset="25"
                        />
                      </svg>
                      <span className="dp-req-ring-label">{majorRing.pct}%</span>
                    </div>
                    <div className="dp-req-prog-text">
                      <span className="dp-req-prog-name">Major</span>
                      <span className="dp-req-prog-detail">{majorRing.earned}/{majorRing.total} credits</span>
                    </div>
                  </div>
                )}
                {hasConcentration && (
                  <div className="dp-req-progress-item">
                    <div className="dp-req-ring">
                      <svg viewBox="0 0 36 36" className="dp-req-ring-svg">
                        <circle cx="18" cy="18" r="15.9" className="dp-req-ring-bg" />
                        <circle cx="18" cy="18" r="15.9"
                          className="dp-req-ring-fill" style={{ stroke: '#7c3aed' }}
                          strokeDasharray={`${concentrationRing.pct} ${100 - concentrationRing.pct}`}
                          strokeDashoffset="25"
                        />
                      </svg>
                      <span className="dp-req-ring-label">{concentrationRing.pct}%</span>
                    </div>
                    <div className="dp-req-prog-text">
                      <span className="dp-req-prog-name">Concentration</span>
                      <span className="dp-req-prog-detail">{concentrationRing.earned}/{concentrationRing.total} credits</span>
                    </div>
                  </div>
                )}
              </>
            ) : (
              <>
                {hasMajor && (
                  <div className="dp-req-progress-item">
                    <div className="dp-req-ring">
                      <svg viewBox="0 0 36 36" className="dp-req-ring-svg">
                        <circle cx="18" cy="18" r="15.9" className="dp-req-ring-bg" />
                        <circle cx="18" cy="18" r="15.9"
                          className="dp-req-ring-fill dp-req-ring-fill--major"
                          strokeDasharray={`${majorRing.pct} ${100 - majorRing.pct}`}
                          strokeDashoffset="25"
                        />
                      </svg>
                      <span className="dp-req-ring-label">{majorRing.pct}%</span>
                    </div>
                    <div className="dp-req-prog-text">
                      <span className="dp-req-prog-name">Major</span>
                      <span className="dp-req-prog-detail">{majorRing.earned}/{majorRing.total} credits</span>
                    </div>
                  </div>
                )}
                {hasMinor && (
                  <div className="dp-req-progress-item">
                    <div className="dp-req-ring">
                      <svg viewBox="0 0 36 36" className="dp-req-ring-svg">
                        <circle cx="18" cy="18" r="15.9" className="dp-req-ring-bg" />
                        <circle cx="18" cy="18" r="15.9"
                          className="dp-req-ring-fill dp-req-ring-fill--minor"
                          strokeDasharray={`${minorRing.pct} ${100 - minorRing.pct}`}
                          strokeDashoffset="25"
                        />
                      </svg>
                      <span className="dp-req-ring-label">{minorRing.pct}%</span>
                    </div>
                    <div className="dp-req-prog-text">
                      <span className="dp-req-prog-name">Minor</span>
                      <span className="dp-req-prog-detail">{minorRing.earned}/{minorRing.total} credits</span>
                    </div>
                  </div>
                )}
              </>
            )}
          </div>

          {/* Tab switcher */}
          <div className="dp-prog-tabs">
            {tabs.map(tab => (
              <button
                key={tab.id}
                className={`dp-prog-tab ${activeTab === tab.id ? 'dp-prog-tab--active' : ''}`}
                onClick={() => setActiveTab(tab.id)}
              >
                {tab.id === 'core'          ? `Core: ${tab.label}`
                  : tab.id === 'concentration' ? `Concentration: ${tab.label}`
                  : tab.id === 'sci'           ? `Science: ${tab.label}`
                  : tab.id === 'minor'         ? `Minor: ${tab.label}`
                  : `Major: ${tab.label}`
                }
                {tab.unavailable && !tab.data && (
                  <span style={{ fontSize: '0.7rem', opacity: 0.6, marginLeft: '0.25rem' }}>(N/A)</span>
                )}
              </button>
            ))}
            <button
              className={`dp-prog-tab ${activeTab === 'electives' ? 'dp-prog-tab--active dp-prog-tab--electives' : ''}`}
              onClick={() => setActiveTab('electives')}
            >
              âœ¦ Electives
            </button>
          </div>

          {/* Foundation year waived banner */}
          {foundationWaived && (
            <div style={{
              background: '#e8f5e9', border: '1px solid #a5d6a7', borderRadius: '8px',
              padding: '10px 14px', marginBottom: '12px', fontSize: '13px',
              display: 'flex', alignItems: 'center', gap: '8px', color: '#2e7d32'
            }}>
              <span>âœ“</span>
              <span>
                <strong>Foundation Year Waived</strong> â€” Your {transferCredits} transfer credits
                exempt you from U0 Foundation requirements
                {transferCredits < 30 ? ' (note: 30 cr for full exemption)' : ''}.
              </span>
            </div>
          )}

          {/* Active program blocks */}
          {activeTab !== 'electives' && currentTabData && (
            <ProgramSection
              prog={currentTabData}
              completedCourses={completedCourses}
              currentCourses={currentCourses}
              advStanding={advStanding}
              openBlocks={openBlocks}
              setOpenBlocks={setOpenBlocks}
            />
          )}

          {/* Unavailable tab message */}
          {activeTab !== 'electives' && !currentTabData && currentTabUnavailable && (
            <div className="dp-req-empty" style={{ padding: '1.5rem', textAlign: 'center' }}>
              <p style={{ color: 'var(--text-secondary, #6b7280)', fontSize: '0.9rem', margin: 0 }}>
                Detailed requirements for <strong>{currentTab?.label}</strong> are not yet available.
              </p>
              <p style={{ color: 'var(--text-tertiary, #9ca3af)', fontSize: '0.8rem', marginTop: '0.5rem' }}>
                Check the Degree Requirements tab to browse all available programs.
              </p>
            </div>
          )}

          {/* Electives tab â€” always mounted to preserve state, hidden when inactive */}
          <div style={{ display: activeTab === 'electives' ? 'block' : 'none' }}>
            <ElectivesPanel
              profile={profile}
              completedCourses={completedCourses}
              currentCourses={currentCourses}
              programData={programData}
              minorData={minorData}
            />
          </div>
        </div>
      )}
    </div>
  )
}

// â”€â”€ Main component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default function DegreePlanningView({
  favorites = [],
  completedCourses = [],
  currentCourses = [],
  completedCoursesMap = new Set(),
  currentCoursesMap = new Set(),
  favoritesMap = new Set(),
  profile = {},
  onToggleFavorite,
  onToggleCompleted,
  onToggleCurrent,
  onCourseClick,
  onImportTranscript,
  onImportSyllabus,
}) {
  const { t } = useLanguage()
  const [subTab, setSubTab] = useState('my_courses')

  const isCompleted = (s, c) => completedCoursesMap.has(`${s} ${c}`)
  const isCurrent   = (s, c) => currentCoursesMap.has(`${s} ${c}`)
  const isFavorited = (s, c) => favoritesMap.has(`${s}${c}`)

  return (
    <div className="dp-view">

      {/* â”€â”€ Sub-tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="dp-subtab-bar">
        <button
          className={`dp-subtab-btn ${subTab === 'my_courses' ? 'dp-subtab-btn--active' : ''}`}
          onClick={() => setSubTab('my_courses')}
        >
          <FaGraduationCap className="dp-subtab-icon" />
          <span>My Courses</span>
          {(favorites.length + completedCourses.length + currentCourses.length) > 0 && (
            <span className="dp-subtab-count">
              {favorites.length + completedCourses.length + currentCourses.length}
            </span>
          )}
        </button>
        <button
          className={`dp-subtab-btn ${subTab === 'requirements' ? 'dp-subtab-btn--active' : ''}`}
          onClick={() => setSubTab('requirements')}
        >
          <FaListAlt className="dp-subtab-icon" />
          <span>Degree Requirements</span>
        </button>
      </div>

      {/* â”€â”€ Degree Requirements tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {subTab === 'requirements' && (
        <div className="dp-req-tab-wrap">
          <DegreeRequirementsView
            completedCourses={completedCourses}
            currentCourses={currentCourses}
            profile={profile}
          />
        </div>
      )}

      {/* â”€â”€ My Courses tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {subTab === 'my_courses' && (
        <>
          {/* Degree Progress */}
          <div className="dp-section-card">
            <div className="dp-section-header">
              <span className="dp-section-icon"><FaBullseye /></span>
              <h2 className="dp-section-title">{t('profile.degreeProgress')}</h2>
              <div className="dp-import-btns">
                {onImportTranscript && (
                  <button className="dp-import-btn" onClick={onImportTranscript}>
                    <FaFileUpload /> Transcript
                  </button>
                )}
                {onImportSyllabus && (
                  <button className="dp-import-btn dp-import-btn--secondary" onClick={onImportSyllabus}>
                    <FaBook /> Syllabuses
                  </button>
                )}
              </div>
            </div>
            <DegreeProgressTracker completedCourses={completedCourses} profile={profile} />
          </div>

          {/* My Program Requirements card */}
          <MyProgramCard
            profile={profile}
            completedCourses={completedCourses}
            currentCourses={currentCourses}
          />
        </>
      )}
    </div>
  )
}